metadata:
  name: vpc
  description: AWS VPC（Virtual Private Cloud）を作成するテンプレート
  version: 1.0.0
  provider: aws
  category: network
  tags:
    - vpc
    - network
    - networking

parameters:
  - name: vpc_name
    type: string
    description: VPC名（タグとして設定）
    required: true
    validation:
      minLength: 1
      maxLength: 255

  - name: cidr_block
    type: string
    description: VPCのCIDRブロック
    required: true
    validation:
      pattern: "^([0-9]{1,3}\\.){3}[0-9]{1,3}/[0-9]{1,2}$"

  - name: enable_dns_support
    type: boolean
    description: DNS解決を有効化
    required: false
    default: true

  - name: enable_dns_hostnames
    type: boolean
    description: DNSホスト名を有効化
    required: false
    default: true

  - name: instance_tenancy
    type: string
    description: インスタンステナンシー
    required: false
    default: default
    validation:
      enum:
        - default
        - dedicated
        - host

  - name: create_internet_gateway
    type: boolean
    description: インターネットゲートウェイを作成
    required: false
    default: true

  - name: subnets
    type: array
    description: サブネット設定（CIDR、AZ、パブリック/プライベート）
    required: false
    default: []

  - name: tags
    type: object
    description: VPCに付与するタグ
    required: false
    default: {}

  - name: region
    type: string
    description: VPCを作成するAWSリージョン
    required: false
    default: us-east-1

resources:
  commands:
    create:
      - name: create_vpc
        description: VPCを作成
        command: |
          aws ec2 create-vpc \
            --cidr-block {{cidr_block}} \
            --instance-tenancy {{instance_tenancy}} \
            --tag-specifications 'ResourceType=vpc,Tags=[{Key=Name,Value={{vpc_name}}}{{#each tags}},{Key={{@key}},Value={{this}}}{{/each}}]' \
            --region {{region}} \
            {{#if endpoint_url}}--endpoint-url {{endpoint_url}}{{/if}} \
            --output json

      - name: enable_dns_support
        description: DNS解決を有効化
        condition: "{{enable_dns_support}}"
        command: |
          VPC_ID=$(aws ec2 describe-vpcs \
            --filters "Name=tag:Name,Values={{vpc_name}}" \
            --query 'Vpcs[0].VpcId' \
            --region {{region}} \
            {{#if endpoint_url}}--endpoint-url {{endpoint_url}}{{/if}} \
            --output text) && \
          aws ec2 modify-vpc-attribute \
            --vpc-id $VPC_ID \
            --enable-dns-support \
            --region {{region}} \
            {{#if endpoint_url}}--endpoint-url {{endpoint_url}}{{/if}}

      - name: enable_dns_hostnames
        description: DNSホスト名を有効化
        condition: "{{enable_dns_hostnames}}"
        command: |
          VPC_ID=$(aws ec2 describe-vpcs \
            --filters "Name=tag:Name,Values={{vpc_name}}" \
            --query 'Vpcs[0].VpcId' \
            --region {{region}} \
            {{#if endpoint_url}}--endpoint-url {{endpoint_url}}{{/if}} \
            --output text) && \
          aws ec2 modify-vpc-attribute \
            --vpc-id $VPC_ID \
            --enable-dns-hostnames \
            --region {{region}} \
            {{#if endpoint_url}}--endpoint-url {{endpoint_url}}{{/if}}

      - name: create_internet_gateway
        description: インターネットゲートウェイを作成してアタッチ
        condition: "{{create_internet_gateway}}"
        command: |
          VPC_ID=$(aws ec2 describe-vpcs \
            --filters "Name=tag:Name,Values={{vpc_name}}" \
            --query 'Vpcs[0].VpcId' \
            --region {{region}} \
            {{#if endpoint_url}}--endpoint-url {{endpoint_url}}{{/if}} \
            --output text) && \
          IGW_ID=$(aws ec2 create-internet-gateway \
            --tag-specifications 'ResourceType=internet-gateway,Tags=[{Key=Name,Value={{vpc_name}}-igw}]' \
            --region {{region}} \
            {{#if endpoint_url}}--endpoint-url {{endpoint_url}}{{/if}} \
            --query 'InternetGateway.InternetGatewayId' \
            --output text) && \
          aws ec2 attach-internet-gateway \
            --vpc-id $VPC_ID \
            --internet-gateway-id $IGW_ID \
            --region {{region}} \
            {{#if endpoint_url}}--endpoint-url {{endpoint_url}}{{/if}}

      - name: create_subnets
        description: サブネットを作成
        condition: "{{subnets}}"
        command: |
          VPC_ID=$(aws ec2 describe-vpcs \
            --filters "Name=tag:Name,Values={{vpc_name}}" \
            --query 'Vpcs[0].VpcId' \
            --region {{region}} \
            {{#if endpoint_url}}--endpoint-url {{endpoint_url}}{{/if}} \
            --output text) && \
          {{#each subnets}}
          aws ec2 create-subnet \
            --vpc-id $VPC_ID \
            --cidr-block {{this.cidr}} \
            {{#if this.availability_zone}}--availability-zone {{this.availability_zone}}{{/if}} \
            --tag-specifications 'ResourceType=subnet,Tags=[{Key=Name,Value={{this.name}}},{Key=Type,Value={{this.type}}}]' \
            --region {{../region}} \
            {{#if ../endpoint_url}}--endpoint-url {{../endpoint_url}}{{/if}} && \
          {{/each}}
          echo "All subnets created"

    delete:
      - name: detach_and_delete_igw
        description: インターネットゲートウェイをデタッチして削除
        command: |
          VPC_ID=$(aws ec2 describe-vpcs \
            --filters "Name=tag:Name,Values={{vpc_name}}" \
            --query 'Vpcs[0].VpcId' \
            --region {{region}} \
            {{#if endpoint_url}}--endpoint-url {{endpoint_url}}{{/if}} \
            --output text) && \
          IGW_ID=$(aws ec2 describe-internet-gateways \
            --filters "Name=attachment.vpc-id,Values=$VPC_ID" \
            --query 'InternetGateways[0].InternetGatewayId' \
            --region {{region}} \
            {{#if endpoint_url}}--endpoint-url {{endpoint_url}}{{/if}} \
            --output text) && \
          if [ "$IGW_ID" != "None" ] && [ -n "$IGW_ID" ]; then \
            aws ec2 detach-internet-gateway \
              --vpc-id $VPC_ID \
              --internet-gateway-id $IGW_ID \
              --region {{region}} \
              {{#if endpoint_url}}--endpoint-url {{endpoint_url}}{{/if}} && \
            aws ec2 delete-internet-gateway \
              --internet-gateway-id $IGW_ID \
              --region {{region}} \
              {{#if endpoint_url}}--endpoint-url {{endpoint_url}}{{/if}}; \
          fi

      - name: delete_subnets
        description: すべてのサブネットを削除
        command: |
          VPC_ID=$(aws ec2 describe-vpcs \
            --filters "Name=tag:Name,Values={{vpc_name}}" \
            --query 'Vpcs[0].VpcId' \
            --region {{region}} \
            {{#if endpoint_url}}--endpoint-url {{endpoint_url}}{{/if}} \
            --output text) && \
          SUBNET_IDS=$(aws ec2 describe-subnets \
            --filters "Name=vpc-id,Values=$VPC_ID" \
            --query 'Subnets[*].SubnetId' \
            --region {{region}} \
            {{#if endpoint_url}}--endpoint-url {{endpoint_url}}{{/if}} \
            --output text) && \
          for SUBNET_ID in $SUBNET_IDS; do \
            aws ec2 delete-subnet \
              --subnet-id $SUBNET_ID \
              --region {{region}} \
              {{#if endpoint_url}}--endpoint-url {{endpoint_url}}{{/if}}; \
          done

      - name: delete_vpc
        description: VPCを削除
        command: |
          VPC_ID=$(aws ec2 describe-vpcs \
            --filters "Name=tag:Name,Values={{vpc_name}}" \
            --query 'Vpcs[0].VpcId' \
            --region {{region}} \
            {{#if endpoint_url}}--endpoint-url {{endpoint_url}}{{/if}} \
            --output text) && \
          aws ec2 delete-vpc \
            --vpc-id $VPC_ID \
            --region {{region}} \
            {{#if endpoint_url}}--endpoint-url {{endpoint_url}}{{/if}}

    query:
      - name: describe_vpc
        description: VPC情報を取得
        command: |
          aws ec2 describe-vpcs \
            --filters "Name=tag:Name,Values={{vpc_name}}" \
            --region {{region}} \
            {{#if endpoint_url}}--endpoint-url {{endpoint_url}}{{/if}} \
            --output json

      - name: list_subnets
        description: VPC内のサブネット一覧を取得
        command: |
          VPC_ID=$(aws ec2 describe-vpcs \
            --filters "Name=tag:Name,Values={{vpc_name}}" \
            --query 'Vpcs[0].VpcId' \
            --region {{region}} \
            {{#if endpoint_url}}--endpoint-url {{endpoint_url}}{{/if}} \
            --output text) && \
          aws ec2 describe-subnets \
            --filters "Name=vpc-id,Values=$VPC_ID" \
            --region {{region}} \
            {{#if endpoint_url}}--endpoint-url {{endpoint_url}}{{/if}} \
            --output json

      - name: describe_internet_gateway
        description: インターネットゲートウェイ情報を取得
        command: |
          VPC_ID=$(aws ec2 describe-vpcs \
            --filters "Name=tag:Name,Values={{vpc_name}}" \
            --query 'Vpcs[0].VpcId' \
            --region {{region}} \
            {{#if endpoint_url}}--endpoint-url {{endpoint_url}}{{/if}} \
            --output text) && \
          aws ec2 describe-internet-gateways \
            --filters "Name=attachment.vpc-id,Values=$VPC_ID" \
            --region {{region}} \
            {{#if endpoint_url}}--endpoint-url {{endpoint_url}}{{/if}} \
            --output json

outputs:
  - name: vpc_id
    description: VPC ID
    value: "Vpcs[0].VpcId"

  - name: cidr_block
    description: VPCのCIDRブロック
    value: "Vpcs[0].CidrBlock"

  - name: state
    description: VPCの状態
    value: "Vpcs[0].State"

  - name: vpc_arn
    description: VPCのARN
    value: "arn:aws:ec2:{{region}}:*:vpc/{{vpc_id}}"

validation:
  pre_checks:
    - AWS認証情報が設定されていること
    - 必要なIAM権限があること（ec2:CreateVpc、ec2:CreateSubnet等）
    - CIDRブロックが有効な範囲であること
    - 指定したリージョンが利用可能であること
    - サブネットのCIDRがVPCのCIDR範囲内であること

  post_checks:
    - VPCが正常に作成されたこと
    - DNS設定が正しく反映されていること
    - インターネットゲートウェイがアタッチされていること（作成時）
    - サブネットが正常に作成されたこと（指定時）
    - タグが正しく適用されていること

examples:
  - name: 基本的なVPC作成
    description: シンプルなVPCを作成
    parameters:
      vpc_name: my-vpc
      cidr_block: 10.0.0.0/16
      enable_dns_support: true
      enable_dns_hostnames: true
      create_internet_gateway: true

  - name: サブネット付きVPC作成
    description: パブリックサブネットとプライベートサブネットを持つVPCを作成
    parameters:
      vpc_name: production-vpc
      cidr_block: 10.0.0.0/16
      enable_dns_support: true
      enable_dns_hostnames: true
      create_internet_gateway: true
      subnets:
        - name: public-subnet-1a
          cidr: 10.0.1.0/24
          availability_zone: us-east-1a
          type: public
        - name: public-subnet-1b
          cidr: 10.0.2.0/24
          availability_zone: us-east-1b
          type: public
        - name: private-subnet-1a
          cidr: 10.0.10.0/24
          availability_zone: us-east-1a
          type: private
        - name: private-subnet-1b
          cidr: 10.0.11.0/24
          availability_zone: us-east-1b
          type: private
      tags:
        Environment: Production
        Project: SuperClaude

  - name: LocalStack環境でのVPC作成
    description: LocalStackでテスト用VPCを作成
    parameters:
      vpc_name: test-vpc
      cidr_block: 172.16.0.0/16
      enable_dns_support: true
      enable_dns_hostnames: true
      create_internet_gateway: false
      endpoint_url: http://localhost:4566
      region: us-east-1
